<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo de Entrega Digital</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/8655/8655909.png" type="image/png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/8655/8655909.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos adicionais para o app */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .view { display: none; }
        .view.active { display: block; }
        #reader {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #reader video {
            width: 100% !important;
            height: auto !important;
        }
        .signature-canvas {
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            width: 100%;
            height: 200px;
            cursor: crosshair;
        }
        .protocol-item { cursor: pointer; }
        .status-message {
            transition: opacity 0.5s ease-out;
        }
        .btn-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        /* Estilo para item selecionado na lista de consulta */
        .protocol-item.selected {
            background-color: #dbeafe; /* Azul claro */
            border-color: #3b82f6; /* Azul */
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans">

    <main class="container mx-auto max-w-lg p-4 min-h-screen bg-gradient-to-b from-white to-sky-50 shadow-lg">

        <section id="main-view" class="view active">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-sky-800">Protocolo de Entrega</h1>
                <p class="text-slate-500">Gestão digital de comprovantes</p>
            </header>

            <div class="space-y-4">
                <button id="goto-scanner-btn" class="w-full flex items-center justify-center bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 transition duration-300 shadow-md disabled:bg-slate-400" disabled>
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" focusable="false"><title>Ícone de QR Code</title><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5A.75.75 0 014.5 3.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM3.75 18a.75.75 0 01.75.75v1.5c0 .414.336.75.75.75h1.5a.75.75 0 010 1.5h-1.5A2.25 2.25 0 013 19.5v-1.5a.75.75 0 01.75-.75zM18 3.75a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5a.75.75 0 01.75-.75zM19.5 18a.75.75 0 01.75.75v1.5a2.25 2.25 0 01-2.25 2.25h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 00.75-.75v-1.5a.75.75 0 01.75-.75zM9 12.75a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 8.25V7.5h1.5V6H3v2.25zm18 0V7.5h-1.5V6H21v2.25zM3 15.75V15h1.5v1.5H3v-1.5zm18 0V15h-1.5v1.5H21v-1.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75h6v1.5H9v-1.5zm0 15h6v1.5H9v-1.5z" /></svg>
                    Escanear QR Codes
                </button>
                <button id="goto-consultas-btn" class="w-full flex items-center justify-center bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700 transition duration-300 shadow-md disabled:bg-slate-400" disabled>
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><title>Ícone de prancheta</title><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Consultar Protocolos
                </button>
            </div>
            <div id="connection-status" class="mt-8 text-center text-xs text-slate-500">Inicializando banco de dados...</div>
        </section>

        <section id="scanner-view" class="view">
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-sky-800">Escanear QR Codes</h1>
                <p class="text-slate-500">Aponte a câmera para os códigos.</p>
            </header>
            <div id="reader-container" class="relative w-full aspect-square bg-slate-800 rounded-lg overflow-hidden">
                 <div id="reader"></div>
            </div>
            <div id="scan-status" class="text-center font-semibold p-2 my-2 rounded-md status-message opacity-0"></div>
            <div class="mt-4">
                <h3 class="font-semibold text-slate-700">Itens Escaneados: <span id="scan-count">0</span></h3>
                <div id="scanned-list" class="mt-2 space-y-1 max-h-32 overflow-y-auto bg-slate-50 p-2 rounded-md border border-slate-200">
                    <p class="text-xs text-slate-500">Aguardando leitura...</p>
                </div>
            </div>
            <button id="finish-scan-btn" class="mt-4 w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition duration-300 disabled:bg-slate-400 shadow-sm" disabled>
                Preencher Protocolos
            </button>
            <button class="back-to-main-btn mt-2 w-full bg-rose-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-rose-700 transition duration-300 shadow-sm">
                Cancelar e Voltar
            </button>
        </section>

        <section id="protocol-view" class="view">
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-sky-800">Preencher Protocolo</h1>
                <p class="text-slate-500">Complete as informações da entrega.</p>
            </header>
            <div id="protocol-forms-container" class="space-y-4">
                 <!-- Formulário será inserido aqui -->
            </div>
            <div class="mt-8 pt-4 border-t border-slate-200">
                <button id="save-all-protocols-btn" class="w-full bg-blue-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-800 text-lg shadow-md">Salvar Protocolo</button>
                <button class="back-to-main-btn mt-2 w-full text-center text-sm text-slate-600 hover:underline">Cancelar e Voltar</button>
            </div>
        </section>
        
        <section id="summary-view" class="view">
            <header class="text-center mb-6">
                <h1 id="summary-title" class="text-2xl font-bold text-green-600"></h1>
                <p id="summary-subtitle" class="text-slate-500"></p>
            </header>
            <div class="space-y-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <div id="summary-items-list" class="space-y-2 text-sm">
                </div>
            </div>
            <button id="summary-back-btn" class="mt-6 w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700">Voltar ao Início</button>
        </section>

        <section id="consultas-view" class="view">
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-sky-800">Consultar Protocolos</h1>
                <p class="text-slate-500">Busque por entregas salvas.</p>
            </header>
            <div class="my-4">
                <input type="text" id="search-input" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="Buscar por pedido, NF ou TAG...">
            </div>
            <p class="text-xs text-slate-500 mb-2">Toque nos itens para selecionar.</p>
            <div id="protocol-list" class="mt-1 space-y-2 max-h-80 overflow-y-auto"></div>
            <div class="flex space-x-2 mt-4">
                 <button id="download-pdf-btn" class="w-full flex items-center justify-center bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 transition duration-300 disabled:bg-slate-400 shadow-sm" disabled>
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><title>Ícone de download</title><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span>Baixar PDF</span>
                </button>
            </div>
            <button class="back-to-main-btn mt-6 w-full text-center text-sm text-slate-600 hover:underline">Voltar ao Início</button>
        </section>

    </main>
    
    <canvas id="photo-canvas" class="hidden"></canvas>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const views = {
                main: document.getElementById('main-view'),
                scanner: document.getElementById('scanner-view'),
                protocol: document.getElementById('protocol-view'),
                summary: document.getElementById('summary-view'),
                consultas: document.getElementById('consultas-view'),
            };

            let db;
            let html5QrCode;
            let signaturePad; 
            let scannedItems = [];
            let statusTimeout;
            let capturedPhotoData = null; 
            let currentCameraStream = null;

            // --- BANCO DE DADOS (INDEXEDDB) ---
            function initDB() {
                const request = indexedDB.open('protocolosDB', 1);

                request.onupgradeneeded = (event) => {
                    const dbInstance = event.target.result;
                    if (!dbInstance.objectStoreNames.contains('entregas')) {
                        const store = dbInstance.createObjectStore('entregas', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('search_idx', ['pedido', 'nf', 'recebedor', 'tag'], { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Banco de dados iniciado com sucesso.');
                    document.getElementById('goto-scanner-btn').disabled = false;
                    document.getElementById('goto-consultas-btn').disabled = false;
                    updateConnectionStatus();
                };

                request.onerror = (event) => {
                    console.error('Erro ao iniciar o banco de dados:', event.target.errorCode);
                    const statusEl = document.getElementById('connection-status');
                    statusEl.textContent = 'Falha crítica: O banco de dados não pôde ser carregado.';
                    statusEl.className = 'mt-8 text-center text-xs text-red-600 font-bold';
                };
            }

            function saveProtocolToDB(protocol) {
                return new Promise((resolve, reject) => {
                    if (!db) reject('Banco de dados não está disponível.');
                    const transaction = db.transaction(['entregas'], 'readwrite');
                    const store = transaction.objectStore('entregas');
                    const request = store.add(protocol);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            function getAllProtocolsFromDB() {
                return new Promise((resolve, reject) => {
                    if (!db) reject('Banco de dados não está disponível.');
                    const transaction = db.transaction(['entregas'], 'readonly');
                    const store = transaction.objectStore('entregas');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result.sort((a,b) => b.id - a.id));
                    request.onerror = () => reject(request.error);
                });
            }

            function searchProtocolsInDB(query) {
                return new Promise((resolve, reject) => {
                    getAllProtocolsFromDB().then(allProtocols => {
                        if (!query) {
                            resolve(allProtocols);
                            return;
                        }
                        const lowerCaseQuery = query.toLowerCase();
                        const results = allProtocols.filter(p => {
                            const isRecebedorMatch = p.recebedor.toLowerCase().includes(lowerCaseQuery);
                            const isTagMatch = p.tag && p.tag.toLowerCase().includes(lowerCaseQuery);
                            const isItemMatch = p.items && p.items.some(item => 
                                item.pedido.toLowerCase().includes(lowerCaseQuery) || 
                                item.nf.toLowerCase().includes(lowerCaseQuery)
                            );
                            return isRecebedorMatch || isItemMatch || isTagMatch;
                        });
                        resolve(results);
                    }).catch(reject);
                });
            }
            
            // --- NAVEGAÇÃO E STATUS ---
            function showView(viewName) {
                Object.values(views).forEach(view => view.classList.remove('active'));
                if (views[viewName]) views[viewName].classList.add('active');
            }

            function updateConnectionStatus() {
                const statusEl = document.getElementById('connection-status');
                if (navigator.onLine) {
                    statusEl.textContent = 'Status: Online';
                    statusEl.className = 'mt-8 text-center text-xs text-green-600';
                } else {
                    statusEl.textContent = 'Status: Offline (dados serão salvos localmente)';
                    statusEl.className = 'mt-8 text-center text-xs text-red-600';
                }
            }

            document.getElementById('goto-scanner-btn').addEventListener('click', () => {
                scannedItems = [];
                updateScannedListUI();
                showView('scanner');
                startScanner();
            });

            document.getElementById('goto-consultas-btn').addEventListener('click', async () => {
                showView('consultas');
                await displayProtocols();
            });

            document.querySelectorAll('.back-to-main-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (html5QrCode && html5QrCode.isScanning) stopScanner();
                    closeCamera();
                    showView('main');
                });
            });
            
            document.getElementById('summary-back-btn').addEventListener('click', () => showView('main'));

            // --- SCANNER ---
            function showScanStatus(message, type = 'success') {
                const statusEl = document.getElementById('scan-status');
                statusEl.textContent = message;
                statusEl.className = 'text-center font-semibold p-2 my-2 rounded-md status-message'; // Reset
                if (type === 'success') statusEl.classList.add('bg-green-100', 'text-green-800');
                else if (type === 'warning') statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
                else statusEl.classList.add('bg-red-100', 'text-red-800');
                
                statusEl.style.opacity = '1';
                if (statusTimeout) clearTimeout(statusTimeout);
                statusTimeout = setTimeout(() => { statusEl.style.opacity = '0'; }, 2000);
            }

            function handleScanSuccess(decodedText) {
                try {
                    const data = JSON.parse(decodedText);
                    if (data && typeof data === 'object' && data.pedido && data.nf) {
                        const isDuplicate = scannedItems.some(item => item.pedido === data.pedido && item.nf === data.nf);
                        if (isDuplicate) {
                            showScanStatus('Item já escaneado!', 'warning');
                        } else {
                            scannedItems.push(data);
                            updateScannedListUI();
                            showScanStatus('Item Adicionado!', 'success');
                            if (navigator.vibrate) navigator.vibrate(100);
                        }
                    } else {
                       showScanStatus('QR Code Inválido', 'error');
                    }
                } catch (e) {
                   showScanStatus('QR Code Inválido', 'error');
                }
            }

            function updateScannedListUI() {
                const listContainer = document.getElementById('scanned-list');
                const countEl = document.getElementById('scan-count');
                const finishBtn = document.getElementById('finish-scan-btn');
                countEl.textContent = scannedItems.length;
                if (scannedItems.length === 0) {
                    listContainer.innerHTML = '<p class="text-xs text-slate-500">Aguardando leitura...</p>';
                    finishBtn.disabled = true;
                } else {
                    listContainer.innerHTML = '';
                    scannedItems.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'text-xs p-1 bg-white rounded border border-slate-200';
                        div.textContent = `Pedido: ${item.pedido}, NF: ${item.nf}`;
                        listContainer.appendChild(div);
                    });
                    finishBtn.disabled = false;
                }
            }
            
            function startScanner() {
                html5QrCode = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                html5QrCode.start({ facingMode: "environment" }, config, handleScanSuccess)
                .catch(err => {
                    alert("Não foi possível acessar a câmera. Verifique as permissões.");
                    showView('main');
                });
            }

            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Erro ao parar scanner.", err));
                }
            }

            document.getElementById('finish-scan-btn').addEventListener('click', () => {
                if (scannedItems.length === 0) return;
                stopScanner();
                showView('protocol');
                setTimeout(populateProtocolForm, 50); // Timeout to ensure the view is visible
            });

            // --- Camera ---
            function openCamera() {
                const previewContainer = document.getElementById('photo-preview-container-0');
                const cameraContainer = document.getElementById('camera-container-0');
                const video = document.getElementById('camera-feed-0');

                if (!previewContainer || !cameraContainer || !video) return;

                previewContainer.classList.add('hidden');
                cameraContainer.classList.remove('hidden');

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                        .then(stream => {
                            currentCameraStream = stream;
                            video.srcObject = stream;
                            video.play();
                        })
                        .catch(err => {
                            console.error("Erro ao acessar a câmera: ", err);
                            alert("Não foi possível acessar a câmera. Verifique as permissões.");
                            closeCamera();
                        });
                }
            }

            function closeCamera() {
                if (currentCameraStream) {
                    currentCameraStream.getTracks().forEach(track => track.stop());
                    currentCameraStream = null;
                }
                const previewContainer = document.getElementById('photo-preview-container-0');
                const cameraContainer = document.getElementById('camera-container-0');
                
                if (!previewContainer || !cameraContainer) return;

                previewContainer.classList.remove('hidden');
                cameraContainer.classList.add('hidden');
            }

            function capturePhoto() {
                const canvas = document.getElementById('photo-canvas');
                const video = document.getElementById('camera-feed-0');
                const photoPreview = document.getElementById('photo-preview-0');
                
                if (!canvas || !video || !photoPreview) {
                    console.error("Elementos da câmera não encontrados!");
                    closeCamera();
                    return;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                capturedPhotoData = canvas.toDataURL('image/jpeg');
                photoPreview.src = capturedPhotoData;
                closeCamera();
            }

            // --- PROTOCOLO (ÚNICO FORMULÁRIO) ---
            function populateProtocolForm() {
                const container = document.getElementById('protocol-forms-container');
                container.innerHTML = ''; 
                capturedPhotoData = null; 
                
                const formHtml = `
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm" id="protocol-form-0">
                        <div class="mb-4">
                            <label for="recebedor-0" class="block text-sm font-medium text-slate-700">Nome do Recebedor</label>
                            <input type="text" id="recebedor-0" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="matricula-0" class="block text-sm font-medium text-slate-700">Matrícula</label>
                            <input type="text" id="matricula-0" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                         <div class="mb-4">
                            <label for="tag-0" class="block text-sm font-medium text-slate-700">TAG / Observação</label>
                            <input type="text" id="tag-0" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Bloco A, Apto 101">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-slate-700">Foto do Recebedor</label>
                            <div class="mt-1">
                                <div id="photo-preview-container-0">
                                    <div class="flex items-center space-x-4">
                                        <img id="photo-preview-0" src="https://placehold.co/100x100/e2e8f0/cbd5e1?text=Foto" class="w-24 h-24 rounded-md object-cover bg-slate-200 border">
                                        <button type="button" id="open-camera-btn-0" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition duration-300">Ligar Câmera</button>
                                    </div>
                                </div>
                                <div id="camera-container-0" class="hidden">
                                    <video id="camera-feed-0" class="w-full rounded-lg border bg-slate-200" autoplay playsinline></video>
                                    <div class="flex space-x-4 mt-2">
                                        <button type="button" id="capture-photo-btn-0" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700">Capturar</button>
                                        <button type="button" id="close-camera-btn-0" class="w-full bg-rose-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-rose-700">Cancelar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-slate-700">Assinatura</label>
                            <canvas id="signature-canvas-0" class="signature-canvas mt-1"></canvas>
                        </div>
                        <button type="button" id="clear-signature-0" class="w-full text-sm text-center text-rose-600 hover:underline">Limpar Assinatura</button>
                    </div>
                `;
                container.innerHTML = formHtml;
                
                document.getElementById('open-camera-btn-0').addEventListener('click', openCamera);
                document.getElementById('capture-photo-btn-0').addEventListener('click', capturePhoto);
                document.getElementById('close-camera-btn-0').addEventListener('click', closeCamera);
                
                const canvas = document.getElementById('signature-canvas-0');
                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)'
                });
                
                document.getElementById('clear-signature-0').addEventListener('click', () => {
                    signaturePad.clear();
                });

                window.addEventListener('resize', () => resizeCanvas(canvas, signaturePad));
                resizeCanvas(canvas, signaturePad);
            }

            function resizeCanvas(canvas, pad) {
                if (!canvas) return;
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                if (pad) pad.clear(); 
            }

            document.getElementById('save-all-protocols-btn').addEventListener('click', async () => {
                const recebedor = document.getElementById('recebedor-0').value.trim();
                const matricula = document.getElementById('matricula-0').value.trim();
                const tag = document.getElementById('tag-0').value.trim();

                if (!recebedor) {
                    alert('O nome do recebedor é obrigatório.');
                    return;
                }
                if (signaturePad.isEmpty()) {
                    alert('A assinatura é obrigatória.');
                    return;
                }

                const protocol = {
                    items: scannedItems,
                    recebedor: recebedor,
                    matricula: matricula,
                    tag: tag,
                    foto: capturedPhotoData,
                    assinatura: signaturePad.toDataURL(),
                    timestamp: new Date().toISOString(),
                };

                try {
                    await saveProtocolToDB(protocol);
                    showSummary(protocol, 'salvo');
                } catch (error) {
                    console.error('Erro ao salvar protocolo:', error);
                    alert('Falha ao salvar o protocolo.');
                }
            });
            
            // --- RESUMO ---
            function showSummary(protocol, action) {
                document.getElementById('summary-title').textContent = `Protocolo ${action} com Sucesso!`;
                document.getElementById('summary-subtitle').textContent = `Recebedor: ${protocol.recebedor}`;

                const listContainer = document.getElementById('summary-items-list');
                listContainer.innerHTML = protocol.items.map(item => `
                    <div class="p-2 bg-white rounded border border-slate-200">
                        <strong>Pedido:</strong> ${item.pedido}, <strong>NF:</strong> ${item.nf}
                    </div>
                `).join('');
                
                showView('summary');
            }
            
            // --- CONSULTAS ---
            async function displayProtocols(query = '') {
                const listEl = document.getElementById('protocol-list');
                try {
                    const protocols = await searchProtocolsInDB(query);
                    if (protocols.length === 0) {
                        listEl.innerHTML = '<p class="text-center text-slate-500">Nenhum protocolo encontrado.</p>';
                        return;
                    }
                    listEl.innerHTML = protocols.map(p => `
                        <div class="protocol-item p-3 bg-white rounded-lg border border-slate-200 shadow-sm" data-id="${p.id}">
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-slate-800">${p.recebedor}</p>
                                <p class="text-xs text-slate-500">ID: ${p.id}</p>
                            </div>
                            <p class="text-sm text-slate-600">Itens: ${p.items.length}</p>
                             <p class="text-sm text-slate-600">TAG: ${p.tag || 'N/A'}</p>
                            <p class="text-xs text-slate-400 mt-1">${new Date(p.timestamp).toLocaleString('pt-BR')}</p>
                        </div>
                    `).join('');

                    listEl.querySelectorAll('.protocol-item').forEach(item => {
                        item.addEventListener('click', () => {
                            item.classList.toggle('selected');
                            updateDownloadButtonState();
                        });
                    });

                } catch (error) {
                    console.error("Erro ao buscar protocolos:", error);
                    listEl.innerHTML = '<p class="text-center text-red-500">Erro ao carregar dados.</p>';
                }
            }
            
            document.getElementById('search-input').addEventListener('input', (e) => {
                displayProtocols(e.target.value);
            });
            
            function updateDownloadButtonState() {
                const selectedItems = document.querySelectorAll('#protocol-list .protocol-item.selected').length;
                document.getElementById('download-pdf-btn').disabled = selectedItems === 0;
            }

            // --- GERAÇÃO DE PDF ---
            document.getElementById('download-pdf-btn').addEventListener('click', async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const selectedItems = document.querySelectorAll('#protocol-list .protocol-item.selected');
                
                if (selectedItems.length === 0) return;
                
                const protocolIds = Array.from(selectedItems).map(el => parseInt(el.dataset.id));
                const allProtocols = await getAllProtocolsFromDB();
                const protocolsToPrint = allProtocols.filter(p => protocolIds.includes(p.id));

                protocolsToPrint.forEach((protocol, index) => {
                    if (index > 0) doc.addPage();
                    
                    doc.setFontSize(18);
                    doc.text("Comprovante de Entrega", 105, 20, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.text(`Protocolo ID: ${protocol.id}`, 20, 40);
                    doc.text(`Data: ${new Date(protocol.timestamp).toLocaleString('pt-BR')}`, 20, 48);
                    
                    doc.text(`Recebedor: ${protocol.recebedor}`, 20, 60);
                    doc.text(`Matrícula: ${protocol.matricula || 'Não informada'}`, 20, 68);
                    doc.text(`TAG/Obs: ${protocol.tag || 'Nenhuma'}`, 20, 76);
                    
                    doc.setFontSize(14);
                    doc.text("Itens Entregues:", 20, 90);
                    let yPos = 98;
                    protocol.items.forEach(item => {
                         if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                         }
                         doc.setFontSize(10);
                         doc.text(`- Pedido: ${item.pedido} / NF: ${item.nf}`, 25, yPos);
                         yPos += 7;
                    });
                    
                    yPos = Math.max(yPos, 110); // Start signature/photo section lower if list is short

                    doc.setFontSize(12);
                    doc.text("Assinatura do Recebedor:", 20, yPos);
                    try {
                        doc.addImage(protocol.assinatura, 'PNG', 20, yPos + 5, 80, 40);
                    } catch (e) {
                        doc.text("Erro ao carregar assinatura.", 20, yPos + 10);
                    }

                    if(protocol.foto) {
                        doc.text("Foto do Recebedor:", 110, yPos);
                        try {
                            doc.addImage(protocol.foto, 'JPEG', 110, yPos + 5, 80, 60); 
                        } catch (e) {
                            doc.text("Erro ao carregar foto.", 110, yPos + 10);
                        }
                    }
                });
                
                doc.save(`protocolos_${Date.now()}.pdf`);
            });

            // --- INICIALIZAÇÃO ---
            initDB();
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
        });
    </script>
</body>
</html>

